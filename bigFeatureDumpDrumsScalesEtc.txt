On PianoKeyboard, add a new Drum tab.  The controls on the Drum tab are just all the MIDI Standard drums, in order-- the tinysynth synthesizer object has these names as a public property so you don't have to repeat them.  When a drum control is pressed, a note-on should be sent on the drum channel (channel 10, or zero-based channel 9) through the PianoKeyboard's midi callback function.  It should have the velocity controlled by the Velocity, Min and Max controls like the keys.  A note-off should be sent when the button is released, so you'll have to tell me some updates for ButtonControl so that it can call an OPTIONAL onRelease function.



You should also add an additional tab after Drums called Chords.  This displays buttons with common chords.  The chords, in order, should be C Major, F Major, G Major, A Minor, E Minor, D Minor, C7, and CMaj7.  These chords should send Midi messages exactly as if the three or four notes in question had been pressed on the keyboard, except that instead of the device name being "internal," it will be "chord."



Next you should add an additional tab after Chords called Drum Machine.  The Drum Machine has a RowControl at the top that contains the following controls: Play, Stop, and a horizontal slider control that controls the amount of "swing" (defaults to no swing).  Below that it has a RowControl for every type of MIDI standard drum, labeled on the left.  To the right of the drum label is a vertical pop-up volume slider from 0 to 127, defaulting to 127.  (The drum volume is controlled by this, subject to the constraints of the Min and Max controls.)  To the right of the volume is a special new control that you will add to the Drawer module, called DrumbeatControl.  This is a long rectangle subdivided into 32 white squares with black borders (the squares need not be separate). Each small square in the rectangle should be small but able to be tapped successfully with a mobile device.  Every 8 squares there should be a thicker border between them than the rest.  The user can check these boxes, whereupon they get colored in blue, or they can uncheck them; in this way, the user can specify which of the 32 equal beats in a measure gets a drumbeat.  



The drum machine has a Play button and its own playback routine, separate from the PianoRoll, that sends MIDI messages through the callback function in the same way as the manual drum pads.  It's important that it calculate the duration of each note such that the noteOff happens before the next beat that has a note.  The notes will be sent on the drum MIDI channel (10, or 9 in zero-based notation).  The tempo of the drum machine is controlled by the PianoRoll's tempo, by accessing it through the window.pianoRoll variable which is acceptable to do.



Finally we need to add controls to the Scale tab.  First there will be a dropdown called Root containing all of the 12 notes of the scale in order, defaulting to C, indicating the root note for calculating scales.  Next, there will be a dropdown called Scale with choices for scales: None, Pentatonic, Blues, or any of the modes such as Dorian or Mixylodian (look them all up).  None is the normal mode when all notes are available normally.  Next, there will be a dropdown with choices for what to do  with the scale, called Action; its options are None, Highlight, Round Closest, Mute Non-Scale, or White Keys.  In None mode, nothing special happens.  In all the other modes, the notes of that given scale are highlighted by having the white keys be colored light green and the black keys be colored dark green when they aren't pressed (when they are pressed they can have their current pressed colors).  In Round Closest mode, if you press a note that isn't on the scale, it will round to the nearest scale note as well as highlighting.  In Mute Non-Scale, if you press a note that isn't on the scale, it will not send a MIDI message for that note.  In White Keys, you re-map the white keys so that the scale keys of that scale go in order up the white keys of the keyboard, and they're all scale keys (and highlighted as usual), and the black keys are silent.